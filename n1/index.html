<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRATAN! SPOKOJNO! </title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #05080f;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-family: 'Rajdhani', sans-serif;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(0,255,200,0.13) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,255,200,0.13) 1px, transparent 1px);
            background-size: 64px 64px;
            z-index: 0;
            pointer-events: none;
        }

        canvas {
            position: fixed;
            inset: 0;
            pointer-events: none;
            will-change: transform; /* promote to GPU layer */
        }
        #cv-back  { z-index: 1; }
        #cv-front { z-index: 15; }

        /* Card */
        .card {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: 60px 88px 52px;
            background: rgba(3, 5, 14, 0.90);
            border: 1px solid rgba(0, 255, 200, 0.65);
            border-radius: 2px;
            backdrop-filter: blur(20px);
            box-shadow:
                0 0 50px rgba(0, 255, 200, 0.20),
                0 0 110px rgba(130, 0, 255, 0.18),
                inset 0 0 70px rgba(0, 0, 0, 0.65);
            animation: cardFloat 11s ease-in-out infinite;
        }
        @keyframes cardFloat {
            0%, 100% { transform: translateY(0px); }
            50%       { transform: translateY(-9px); }
        }

        /* Corners */
        .c { position: absolute; width: 16px; height: 16px; border-color: rgba(0,255,200,1.0); border-style: solid; filter: drop-shadow(0 0 4px rgba(0,255,200,0.8)); }
        .tl { top:-1px; left:-1px;  border-width:2px 0 0 2px; }
        .tr { top:-1px; right:-1px; border-width:2px 2px 0 0; }
        .bl { bottom:-1px; left:-1px;  border-width:0 0 2px 2px; }
        .br { bottom:-1px; right:-1px; border-width:0 2px 2px 0; }

        .tag {
            font-size: 10px;
            letter-spacing: 5px;
            color: rgba(0,255,200,0.90);
            text-transform: uppercase;
            margin-bottom: 30px;
        }

        /* Main greeting */
        .greeting {
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            font-size: clamp(2rem, 5vw, 3.6rem);
            letter-spacing: 0.42em;
            line-height: 1;
            display: inline-block;
            background: linear-gradient(120deg, #00ffc8 0%, #7c6bff 35%, #f472b6 65%, #00ffc8 100%);
            background-size: 250% 250%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: textFloat 8s ease-in-out infinite, gradShift 9s ease infinite;
            filter: drop-shadow(0 0 28px rgba(0,255,200,0.55));
        }
        @keyframes textFloat {
            0%   { transform: scaleY(0.76) translateY(0px); }
            30%  { transform: scaleY(0.76) translateY(-11px); }
            60%  { transform: scaleY(0.76) translateY(-4px); }
            100% { transform: scaleY(0.76) translateY(0px); }
        }
        @keyframes gradShift {
            0%   { background-position: 0%   50%; filter: drop-shadow(0 0 28px rgba(0,255,200,0.55)); }
            50%  { background-position: 100% 50%; filter: drop-shadow(0 0 40px rgba(167,139,250,0.75)); }
            100% { background-position: 0%   50%; filter: drop-shadow(0 0 28px rgba(0,255,200,0.55)); }
        }

        .subtitle {
            font-size: 0.82rem;
            letter-spacing: 4px;
            color: rgba(190,170,255,0.90);
            text-transform: uppercase;
            margin-top: 22px;
            margin-bottom: 24px;
        }

        .timer {
            font-family: 'Orbitron', monospace;
            font-size: clamp(1.6rem, 4vw, 2.8rem);
            font-weight: 700;
            letter-spacing: 0.12em;
            color: #00ffc8;
            text-shadow: 0 0 18px rgba(0,255,200,0.7), 0 0 40px rgba(0,255,200,0.35);
            margin-bottom: 28px;
            animation: timerGlow 2s ease-in-out infinite;
        }
        .timer.done {
            color: #f472b6;
            text-shadow: 0 0 18px rgba(244,114,182,0.8), 0 0 40px rgba(244,114,182,0.4);
        }
        .emoji-bounce {
            display: inline-block;
            -webkit-text-fill-color: initial;
            background: none;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.25));
            animation: softBounce 4s ease-in-out infinite;
            transform-origin: center bottom;
        }
        @keyframes softBounce {
            0%   { transform: translateY(0px)   scaleX(1.12) scaleY(0.88); }
            50%  { transform: translateY(-8px)  scaleX(0.93) scaleY(1.10); }
            100% { transform: translateY(0px)   scaleX(1.12) scaleY(0.88); }
        }

        @keyframes timerGlow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.75; }
        }

        .divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
        }
        .dl { flex:1; height:1px; background:linear-gradient(90deg,transparent,rgba(0,255,200,0.85),transparent); }
        .dd {
            width:4px; height:4px; border-radius:50%;
            background:#00ffc8; box-shadow:0 0 8px #00ffc8;
            animation: blink 2.8s ease-in-out infinite;
        }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.1} }

        .status {
            display: flex;
            gap: 22px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .si {
            display:flex; align-items:center; gap:7px;
            font-size:0.7rem; letter-spacing:2px;
            color:rgba(190,175,255,0.95); text-transform:uppercase;
        }
        .sd { width:5px; height:5px; border-radius:50%; animation:blink 2s ease-in-out infinite; }
        .cyan   { background:#00ffc8; box-shadow:0 0 6px #00ffc8; }
        .purple { background:#a78bfa; box-shadow:0 0 6px #a78bfa; animation-delay:.7s; }
        .pink   { background:#f472b6; box-shadow:0 0 6px #f472b6; animation-delay:1.3s; }

        .footer {
            position:fixed; bottom:20px; z-index:10;
            font-size:.62rem; letter-spacing:4px;
            color:rgba(0,255,200,0.55); text-transform:uppercase;
        }

        /* ‚îÄ‚îÄ Sidebar toggle button ‚îÄ‚îÄ */
        .sb-toggle {
            display: none;
            position: fixed;
            right: 0; top: 50%;
            transform: translateY(-50%);
            z-index: 200;
            background: linear-gradient(180deg, #ffe94d, #ffb800, #cc8800);
            border: none;
            border-radius: 10px 0 0 10px;
            width: 44px; height: 80px;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: -4px 0 18px rgba(255,210,0,0.5), inset 0 2px 4px rgba(255,255,255,0.4);
            animation: togglePulse 1.8s ease-in-out infinite;
            transition: width 0.2s;
        }
        .sb-toggle:hover { width: 52px; }
        @keyframes togglePulse {
            0%,100% { box-shadow: -4px 0 18px rgba(255,210,0,0.5), inset 0 2px 4px rgba(255,255,255,0.4); }
            50%      { box-shadow: -4px 0 36px rgba(255,220,0,0.9), inset 0 2px 4px rgba(255,255,255,0.4); }
        }

        /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
        .sidebar {
            position: fixed;
            top: 0; right: 0;
            width: 280px; height: 100vh;
            z-index: 190;
            background: rgba(3, 5, 14, 0.96);
            border-left: 1px solid rgba(0,255,200,0.5);
            backdrop-filter: blur(24px);
            box-shadow: -8px 0 40px rgba(0,255,200,0.12), -4px 0 80px rgba(130,0,255,0.12);
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        .sidebar.open { transform: translateX(0); }

        .sb-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px 14px;
            border-bottom: 1px solid rgba(0,255,200,0.2);
        }
        .sb-title {
            font-family: 'Orbitron', monospace;
            font-size: 0.65rem;
            letter-spacing: 4px;
            color: rgba(0,255,200,0.9);
        }
        .sb-close {
            background: none; border: none; cursor: pointer;
            color: rgba(0,255,200,0.6); font-size: 1rem;
            transition: color 0.2s;
        }
        .sb-close:hover { color: #f472b6; }

        .sb-now {
            padding: 14px 20px;
            border-bottom: 1px solid rgba(0,255,200,0.12);
        }
        .sb-now-label {
            font-size: 0.55rem; letter-spacing: 4px;
            color: rgba(0,255,200,0.5); margin-bottom: 5px;
        }
        .sb-now-name {
            font-family: 'Orbitron', monospace;
            font-size: 0.72rem; letter-spacing: 1px;
            color: #00ffc8;
            text-shadow: 0 0 10px rgba(0,255,200,0.5);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .sb-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        .sb-list::-webkit-scrollbar { width: 3px; }
        .sb-list::-webkit-scrollbar-track { background: transparent; }
        .sb-list::-webkit-scrollbar-thumb { background: rgba(0,255,200,0.3); border-radius: 2px; }

        .sb-track {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 2px solid transparent;
        }
        .sb-track:hover { background: rgba(0,255,200,0.06); }
        .sb-track.active {
            border-left-color: #00ffc8;
            background: rgba(0,255,200,0.08);
        }
        .sb-track-num {
            font-family: 'Orbitron', monospace;
            font-size: 0.6rem; color: rgba(0,255,200,0.4);
            min-width: 18px;
        }
        .sb-track.active .sb-track-num { color: #00ffc8; }
        .sb-track-info { flex: 1; overflow: hidden; }
        .sb-track-title {
            font-size: 0.78rem; letter-spacing: 1px;
            color: rgba(190,175,255,0.9);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .sb-track.active .sb-track-title { color: #fff; }
        .sb-track-artist {
            font-size: 0.62rem; letter-spacing: 1px;
            color: rgba(190,175,255,0.45);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            margin-top: 2px;
        }

        /* ‚îÄ‚îÄ Controls ‚îÄ‚îÄ */
        .sb-controls {
            padding: 16px 20px 24px;
            border-top: 1px solid rgba(0,255,200,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
        }
        .ctrl-btn {
            background: none;
            border: 1px solid rgba(0,255,200,0.3);
            border-radius: 8px;
            color: rgba(0,255,200,0.8);
            font-size: 1rem;
            width: 40px; height: 40px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.15s;
        }
        .ctrl-btn:hover {
            background: rgba(0,255,200,0.1);
            border-color: #00ffc8;
            color: #fff;
            box-shadow: 0 0 10px rgba(0,255,200,0.3);
        }
        .ctrl-btn:active { transform: scale(0.92); }
        .ctrl-btn.main {
            width: 52px; height: 52px; font-size: 1.3rem;
            border-color: rgba(0,255,200,0.6);
            box-shadow: 0 0 14px rgba(0,255,200,0.2);
        }
        .ctrl-btn.main:hover { box-shadow: 0 0 22px rgba(0,255,200,0.5); }
    </style>
</head>
<body>

<canvas id="cv-back"></canvas>

<div class="card">
    <div class="c tl"></div><div class="c tr"></div>
    <div class="c bl"></div><div class="c br"></div>
    <div class="tag">// system online //</div>
    <h1 class="greeting">BRATAN! SKOKOJNO! <span class="emoji-bounce">üòÑ</span></h1>
    <p class="subtitle">HOROSHO.</p>
    <div id="timer" class="timer">00:03</div>
    <div class="divider"><div class="dl"></div><div class="dd"></div><div class="dl"></div></div>
    <div class="status">
        <div class="si"><div class="sd cyan"></div><span>–°–≤—è–∑—å –∞–∫—Ç–∏–≤–Ω–∞</span></div>
        <div class="si"><div class="sd purple"></div><span>–ó–∞—â–∏—Ç–∞ –≤–∫–ª—é—á–µ–Ω–∞</span></div>
        <div class="si"><div class="sd pink"></div><span>–í—Å—ë —Å–ø–æ–∫–æ–π–Ω–æ</span></div>
    </div>
</div>

<canvas id="cv-front"></canvas>

<!-- Sidebar toggle -->
<button id="sb-toggle" class="sb-toggle" title="–ü–ª–µ–π–ª–∏—Å—Ç">üéµ</button>

<!-- Sidebar -->
<div id="sidebar" class="sidebar">
    <div class="sb-header">
        <span class="sb-title">// playlist //</span>
        <button class="sb-close" id="sb-close">‚úï</button>
    </div>
    <div class="sb-now">
        <div class="sb-now-label">NOW PLAYING</div>
        <div class="sb-now-name" id="sb-now-name">‚Äî</div>
    </div>
    <div class="sb-list" id="sb-list"></div>
    <div class="sb-controls">
        <button class="ctrl-btn" id="ctrl-prev" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π">‚èÆ</button>
        <button class="ctrl-btn main" id="ctrl-play" title="–ò–≥—Ä–∞—Ç—å">‚ñ∂</button>
        <button class="ctrl-btn" id="ctrl-stop" title="–°—Ç–æ–ø">‚èπ</button>
        <button class="ctrl-btn" id="ctrl-next" title="–°–ª–µ–¥—É—é—â–∏–π">‚è≠</button>
    </div>
</div>
<div class="footer">cyber ¬∑ space ¬∑ v2.0</div>
<div id="fps" style="
    position: fixed; top: 16px; right: 18px; z-index: 100;
    font-family: 'Orbitron', monospace; font-size: 11px;
    color: rgba(0,255,200,0.55); letter-spacing: 2px;
    pointer-events: none;
">-- FPS</div>

<script>
const cvB = document.getElementById('cv-back');
const cvF = document.getElementById('cv-front');
const ctxB = cvB.getContext('2d');
const ctxF = cvF.getContext('2d');

let W, H;
function resize() {
    W = cvB.width = cvF.width = window.innerWidth;
    H = cvB.height = cvF.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

// ‚îÄ‚îÄ 3D config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PERSP   = 820;
const Z_FAR   = 420;
const Z_NEAR  = 280;
const FRONT_Z = 60;

const COLS = [
    [255, 20,  40 ],   // –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π
    [20,  255, 80 ],   // –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –∑–µ–ª—ë–Ω—ã–π
];

// ‚îÄ‚îÄ Sprite cache ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Each color gets ONE pre-rendered offscreen canvas.
// Per-frame we use drawImage() instead of creating gradients ‚Äî ~20x faster.
const SPRITE_R = 40; // body radius in sprite (px)
const SPRITE_SZ = SPRITE_R * 6; // canvas size: body + 2√ó glow padding each side

function makeSprite([r, g, b]) {
    const sc = document.createElement('canvas');
    sc.width = sc.height = SPRITE_SZ;
    const c = sc.getContext('2d');
    const cx = SPRITE_SZ / 2;

    // Outer glow
    const glow = c.createRadialGradient(cx, cx, 0, cx, cx, SPRITE_R * 2.8);
    glow.addColorStop(0,   `rgba(${r},${g},${b},0.30)`);
    glow.addColorStop(0.5, `rgba(${r},${g},${b},0.10)`);
    glow.addColorStop(1,   `rgba(${r},${g},${b},0)`);
    c.fillStyle = glow;
    c.beginPath();
    c.arc(cx, cx, SPRITE_R * 2.8, 0, Math.PI * 2);
    c.fill();

    // Sphere body with specular highlight
    const body = c.createRadialGradient(
        cx - SPRITE_R * 0.3, cx - SPRITE_R * 0.34, SPRITE_R * 0.04,
        cx, cx, SPRITE_R
    );
    body.addColorStop(0,    `rgba(255,255,255,0.75)`);
    body.addColorStop(0.22, `rgba(${r},${g},${b},1.0)`);
    body.addColorStop(0.65, `rgba(${r},${g},${b},0.55)`);
    body.addColorStop(1,    `rgba(${r},${g},${b},0.02)`);
    c.fillStyle = body;
    c.beginPath();
    c.arc(cx, cx, SPRITE_R, 0, Math.PI * 2);
    c.fill();

    // Bottom rim reflection
    const rimY = cx + SPRITE_R * 0.55;
    const rim = c.createRadialGradient(cx, rimY, 0, cx, rimY, SPRITE_R * 0.42);
    rim.addColorStop(0, 'rgba(255,255,255,0.22)');
    rim.addColorStop(1, 'rgba(255,255,255,0)');
    c.fillStyle = rim;
    c.beginPath();
    c.arc(cx, rimY, SPRITE_R * 0.42, 0, Math.PI * 2);
    c.fill();

    return sc;
}

const sprites = COLS.map(makeSprite);

// ‚îÄ‚îÄ Bubble ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class Bubble {
    constructor(spread) { this.spawn(spread); }

    spawn(spread = false) {
        this.x  = (Math.random() - 0.5) * W * 1.5;
        this.y  = spread
            ? (Math.random() - 0.5) * H * 1.5
            : H * 0.55 + Math.random() * H * 0.4;

        this.z0     = Math.random() * (Z_FAR + Z_NEAR) - Z_FAR;
        this.z      = this.z0;
        this.vx     = (Math.random() - 0.5) * 0.22;
        this.vy     = -(Math.random() * 0.3 + 0.1);
        this.zAmp   = Math.random() * 130 + 60;
        this.zSpd   = Math.random() * 0.0005 + 0.0002;
        this.phi    = Math.random() * Math.PI * 2;
        this.wAmpX  = Math.random() * 0.35 + 0.08;
        this.wAmpY  = Math.random() * 0.22 + 0.05;
        this.wSpd   = Math.random() * 0.0006 + 0.0003;
        this.r      = Math.random() * 9 + 3;

        const ci    = Math.floor(Math.random() * COLS.length);
        this.sprite = sprites[ci];
        const [rv, gv, bv] = COLS[ci];
        this.dotColor = `rgb(${rv},${gv},${bv})`; // for LOD dots
    }

    update(t) {
        this.z  = this.z0 + Math.sin(t * this.zSpd + this.phi) * this.zAmp;
        this.x += this.vx + Math.sin(t * this.wSpd + this.phi) * this.wAmpX;
        this.y += this.vy + Math.cos(t * this.wSpd * 0.8 + this.phi) * this.wAmpY;
        if (this.y < -H * 0.65) this.spawn(false);
    }

    draw(ctx) {
        const scale = PERSP / (PERSP + Z_FAR - this.z);
        const sx = W / 2 + this.x * scale;
        const sy = H / 2 + this.y * scale;
        const sr = this.r * scale; // screen body radius

        if (sr < 0.4) return;

        // Frustum cull: sprite extends to sr*3 from center
        const ext = sr * 3;
        if (sx + ext < 0 || sx - ext > W || sy + ext < 0 || sy - ext > H) return;

        const alpha = Math.min(0.82, scale * 0.88);

        if (sr < 1.8) {
            // LOD: far/tiny bubble ‚Üí single filled dot, no sprite overhead
            ctx.globalAlpha = alpha * 0.5;
            ctx.fillStyle   = this.dotColor;
            ctx.beginPath();
            ctx.arc(sx, sy, sr, 0, Math.PI * 2);
            ctx.fill();
        } else {
            // Sprite draw: body in sprite = SPRITE_R, on screen = sr
            // draw size = sr * 6  (since sprite is SPRITE_R * 6)
            const ds = sr * 6;
            ctx.globalAlpha = alpha;
            ctx.drawImage(this.sprite, sx - ds * 0.5, sy - ds * 0.5, ds, ds);
        }

        ctx.globalAlpha = 1;
    }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const bubbles = Array.from({length: 62}, () => new Bubble(true));

// ‚îÄ‚îÄ Render loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Use a stable sort: z changes slowly, so the array stays nearly sorted
// (Timsort handles nearly-sorted in O(n) ‚Äî very cheap)
let rafId;
const fpsEl = document.getElementById('fps');
let fpsFrames = 0, fpsLast = 0;

function frame(t) {
    // FPS counter (update every second)
    fpsFrames++;
    if (t - fpsLast >= 1000) {
        fpsEl.textContent = fpsFrames + ' FPS';
        fpsEl.style.color = fpsFrames >= 50 ? 'rgba(0,255,120,0.75)' : 'rgba(255,210,0,0.85)';
        fpsFrames = 0;
        fpsLast   = t;
    }
    ctxB.clearRect(0, 0, W, H);
    ctxF.clearRect(0, 0, W, H);

    bubbles.sort((a, b) => a.z - b.z); // back ‚Üí front

    for (const b of bubbles) {
        b.update(t);
        b.draw(b.z > FRONT_Z ? ctxF : ctxB);
    }

    rafId = requestAnimationFrame(frame);
}

// Pause when tab is hidden to save resources
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        cancelAnimationFrame(rafId);
    } else {
        rafId = requestAnimationFrame(frame);
    }
});

rafId = requestAnimationFrame(frame);

// ‚îÄ‚îÄ Timer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
    const el = document.getElementById('timer');
    let seconds = 3;

    function tick() {
        if (seconds <= 0) {
            el.textContent = '00:00';
            el.classList.add('done');
            document.getElementById('sb-toggle').style.display = 'flex';
            return;
        }
        const m = String(Math.floor(seconds / 60)).padStart(2, '0');
        const s = String(seconds % 60).padStart(2, '0');
        el.textContent = m + ':' + s;
        seconds--;
        setTimeout(tick, 1000);
    }

    tick();
})();

// ‚îÄ‚îÄ Sidebar + Music player ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
    const TRACKS = [
        {
            title: 'We Live This Shit',
            artist: 'Cypress Hill',
            src: 'https://raw.githubusercontent.com/Pneuron1321/n1/main/n1/dugbork%20%E2%80%93%20Cypress%20Hill%20-%20We%20Live%20This%20Shit.m4a'
        },
        {
            title: "You'll Be Under My Wheels",
            artist: 'The Prodigy',
            src: 'https://raw.githubusercontent.com/Pneuron1321/n1/main/n1/The-Prodigy-You-ll-Be-Under-My-Wheels.m4a'
        }
    ];

    let current = 0;
    let audio = null;
    let isPlaying = false;

    const sidebar   = document.getElementById('sidebar');
    const sbToggle  = document.getElementById('sb-toggle');
    const sbClose   = document.getElementById('sb-close');
    const sbList    = document.getElementById('sb-list');
    const sbNowName = document.getElementById('sb-now-name');
    const ctrlPlay  = document.getElementById('ctrl-play');
    const ctrlStop  = document.getElementById('ctrl-stop');
    const ctrlPrev  = document.getElementById('ctrl-prev');
    const ctrlNext  = document.getElementById('ctrl-next');

    // Build track list
    TRACKS.forEach((t, i) => {
        const el = document.createElement('div');
        el.className = 'sb-track';
        el.dataset.index = i;
        el.innerHTML = `
            <span class="sb-track-num">${String(i+1).padStart(2,'0')}</span>
            <div class="sb-track-info">
                <div class="sb-track-title">${t.title}</div>
                <div class="sb-track-artist">${t.artist}</div>
            </div>`;
        el.addEventListener('click', () => { current = i; play(); });
        sbList.appendChild(el);
    });

    function updateUI() {
        // Highlight active track
        sbList.querySelectorAll('.sb-track').forEach((el, i) => {
            el.classList.toggle('active', i === current);
        });
        // Now playing name
        sbNowName.textContent = isPlaying
            ? `${TRACKS[current].artist} ‚Äî ${TRACKS[current].title}`
            : '‚Äî';
        // Play button icon
        ctrlPlay.textContent = isPlaying ? '‚è∏' : '‚ñ∂';
    }

    function play() {
        if (audio) { audio.pause(); audio = null; }
        audio = new Audio(TRACKS[current].src);
        audio.addEventListener('ended', () => {
            current = (current + 1) % TRACKS.length;
            play();
        });
        audio.play();
        isPlaying = true;
        updateUI();
    }

    function pause() {
        if (audio) audio.pause();
        isPlaying = false;
        updateUI();
    }

    function stop() {
        if (audio) { audio.pause(); audio = null; }
        isPlaying = false;
        updateUI();
    }

    // Controls
    ctrlPlay.addEventListener('click', () => {
        if (isPlaying) { pause(); }
        else if (audio) { audio.play(); isPlaying = true; updateUI(); }
        else { play(); }
    });
    ctrlStop.addEventListener('click', stop);
    ctrlNext.addEventListener('click', () => { current = (current + 1) % TRACKS.length; if (isPlaying) play(); else updateUI(); });
    ctrlPrev.addEventListener('click', () => { current = (current - 1 + TRACKS.length) % TRACKS.length; if (isPlaying) play(); else updateUI(); });

    // Sidebar open/close
    sbToggle.addEventListener('click', () => {
        if (sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
        } else {
            sidebar.classList.add('open');
            if (!isPlaying) play();
        }
    });
    sbClose.addEventListener('click', () => sidebar.classList.remove('open'));

    updateUI();
})();
</script>
</body>
</html>
